# –û –ø—Ä–æ–µ–∫—Ç–µ

CRM ‚Äî —ç—Ç–æ –µ–¥–∏–Ω—ã–π backend + frontend, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π –º–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.

Backend: Node.js (@crm/core)
Frontend: React
–ë–î: PostgreSQL
–ú–∏–≥—Ä–∞—Ü–∏–∏: SQL-first (dbmate)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
core/          # backend API (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä)
db/
  migrations/  # –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã
  schema.sql   # –ø–æ–ª–Ω—ã–π —Å–ª–µ–ø–æ–∫ —Å—Ö–µ–º—ã –ë–î (read-only)
```

## –ö–∞–∫ –∑–∞–ø—É—Å–∫–∞—Ç—å backend –ª–æ–∫–∞–ª—å–Ω–æ

```
cd core
pnpm install
pnpm run start
```

Backend –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞:

```
http://127.0.0.1:3000
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```
DATABASE_URL=postgres://crm_app:***@localhost:5432/crm
PORT=3000
NODE_ENV=development
```

## Runbook: –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è DATABASE_URL –∏ API

### Backend (crm-core / crm-api)

–ü–æ—Ä—è–¥–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ env-—Ñ–∞–π–ª–æ–≤:

1. `/etc/crm/core.env` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫).
2. `CORE_ENV_PATH` (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –ø—É—Ç—å –∫ .env).
3. –õ–æ–∫–∞–ª—å–Ω—ã–π `.env` –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –∑–∞–ø—É—Å–∫–∞.

–ö–ª—é—á–µ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

- `DATABASE_URL` (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ) –∏–ª–∏ –Ω–∞–±–æ—Ä `DB_HOST/DB_PORT/DB_NAME/DB_USER/DB_PASSWORD`.
- `PORT`, `NODE_ENV`, `JWT_SECRET`.

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–∂–Ω–æ –ø–æ –ª–æ–≥–∞–º –∑–∞–ø—É—Å–∫–∞ (`CRM API started`) –∏ —á–µ—Ä–µ–∑ `dbmate status`,
–∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ—Ç –∂–µ `DATABASE_URL`, —á—Ç–æ –∏ —Å–µ—Ä–≤–∏—Å.

### UI

Frontend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å `/api` (—Å–º. `ui/src/app/api.ts`), –ø–æ—ç—Ç–æ–º—É –≤ production
`API_BASE_URL` —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–∞—ë—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ reverse proxy (nginx/traefik) –∏–ª–∏ CDN, –∫–æ—Ç–æ—Ä—ã–π
–ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç `/api/*` –Ω–∞ backend (`/api/core/v1`, `/api/v1`, `/api/partners/v1`).

–ï—Å–ª–∏ UI –∏ backend —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –¥–æ–º–µ–Ω–∞—Ö, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–∫—Å–∏/Ingress —Ç–∞–∫, —á—Ç–æ–±—ã `/api`
—É–∫–∞–∑—ã–≤–∞–ª –Ω–∞ –Ω—É–∂–Ω—ã–π backend.

## –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

–ú–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é:

```
dbmate up
```

Backend –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

## ‚ö†Ô∏è Plugin registration & runtime safety

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ

–õ—é–±–æ–π –∫–æ–¥, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π decorate() / –ø–ª–∞–≥–∏–Ω—ã Fastify, –æ–±—è–∑–∞–Ω –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –î–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
–ù–∞—Ä—É—à–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:

- runtime-–æ—à–∏–±–∫–∞–º
- 500 Internal Server Error
- –ø–∞–¥–µ–Ω–∏—è–º –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ (auth, payments, etc.)

### ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ

```
fastify.register(authRoutes)
fastify.register(auditPlugin)
fastify.audit.logEvent(...)
```

–ë–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ audit –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ

```
fastify.register(auditPlugin)
fastify.register(authRoutes)
```

### ‚úÖ Fail-fast —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ï—Å–ª–∏ –ø–ª–∞–≥–∏–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –º–æ–¥—É–ª—è:

```
if (!fastify.audit) {
  throw new Error("Audit plugin not registered")
}
```

–õ—É—á—à–µ:

- —Å–µ—Ä–≤–µ—Ä –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç
- —á–µ–º —Ç–∏—Ö–æ –æ—Ç–¥–∞—ë—Ç 500 –≤ production

### ‚úÖ Defensive coding (–¥–ª—è –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤)

```
fastify.audit?.logEvent?.({
  action: "login_attempt",
  userId
})
```

### ‚ö†Ô∏è Conditional plugins

–ï—Å–ª–∏ –ø–ª–∞–≥–∏–Ω –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ env:

```
if (process.env.ENABLE_AUDIT === "true") {
  fastify.register(auditPlugin)
}
```

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:

- –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ .env.example
- –ø—Ä–æ–≤–µ—Ä—è—Ç—å –µ—ë –Ω–∞–ª–∏—á–∏–µ –≤ production

### üö´ PM2 –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞

Backend –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ PM2.

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:

- pnpm run start
- node server.js

–µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å —É–∂–µ –ø–æ–¥ PM2.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

- pm2 reload crm-core --update-env
- –∏–ª–∏ ecosystem.config.js —Å env_file.

### üß™ –ü–µ—Ä–µ–¥ merge / deploy –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

- –ø–æ—Ä—è–¥–æ–∫ fastify.register
- –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ undefined.*
- –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –±–µ–∑ runtime –æ—à–∏–±–æ–∫
- pm2 logs –ø–æ—Å–ª–µ reload
- login/logout flow

### üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–ª—å

–ù–∏ –æ–¥–∏–Ω –ø–ª–∞–≥–∏–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –ª–æ–º–∞—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –±–∏–∑–Ω–µ—Å-–ø–æ—Ç–æ–∫–∏ (auth, payments, core API).

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –º–∏–≥—Ä–∞—Ü–∏—è–º

- –õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ñ–æ—Ä–º–ª—è—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –Ω–æ–≤—ã–º–∏ SQL-first –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ (dbmate).
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ `db/schema.sql` –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è.
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º–∏ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ON CONFLICT DO NOTHING/UPDATE` –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö).
- `schema_migrations` —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ dbmate.

## üîê –†–æ–ª—å –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

–ì–ª–∞–≤–Ω–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω—ã:

- —Ä–æ–ª—å **admin**;
- –≤—Å–µ permissions;
- –¥–æ—Å—Ç—É–ø –∫:
  - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º —Å–∏—Å—Ç–µ–º—ã,
  - —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —è–∑—ã–∫–∞–º–∏,
  - —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏,
  - —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Ä–æ–ª—è–º–∏.

–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ admin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–µ–ª–∞–µ—Ç—Å—è **–≤—Ä—É—á–Ω—É—é** (–Ω–µ —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏).

–ü—Ä–∏–º–µ—Ä SQL (—Ä—É—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ù–ï –º–∏–≥—Ä–∞—Ü–∏—è):

```sql
-- 1) –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT id, email FROM core.users WHERE email = 'admin@example.com';

-- 2) –ù–∞–π—Ç–∏ —Ä–æ–ª—å admin
SELECT id, code FROM core.roles WHERE code = 'admin';

-- 3) –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
INSERT INTO core.user_roles (user_id, role_id)
VALUES ('<user_id>', '<role_id>')
ON CONFLICT DO NOTHING;
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

- –û–¥–∏–Ω backend ‚Äî –æ–¥–∏–Ω API
- –î–æ–º–µ–Ω—ã –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è —è–≤–Ω–æ
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- –ú–∏–Ω–∏–º—É–º –º–∞–≥–∏–∏, –º–∞–∫—Å–∏–º—É–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏

## –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π API

–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π API –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –±–∞–∑–æ–≤–æ–º—É –ø—É—Ç–∏:

```
/api/partners/v1
```

–û–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–æ–º –∂–µ backend, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç —Å–µ—Ä–≤–∏—Å—ã.

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–∏

- –î–æ–±–∞–≤–∏–ª–∏ defensive –≤—ã–∑–æ–≤—ã audit.logEvent –≤ auth/users —Ä–æ—É—Ç–∏–Ω–≥–µ, —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ audit-–ø–ª–∞–≥–∏–Ω–∞.
- –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∏ –ø—Ä–∞–≤–∏–ª–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Fastify-–ø–ª–∞–≥–∏–Ω–æ–≤ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ fail-fast/defensive –ø–æ–¥—Ö–æ–¥—É (—Ä–∞–∑–¥–µ–ª –≤—ã—à–µ).

## –ü–µ—Ä–µ–±–æ—Ä–∫–∞ UI –∏ Core

### Core

```
cd core
pnpm install
pnpm run build
pm2 reload crm-core --update-env
```

### UI

```
cd ui
pnpm install
pnpm run build
```
